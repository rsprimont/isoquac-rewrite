x-python-version: &python_version "3.13"

services:
  nginx:
    image: nginx:alpine
    ports:
      - 8080:80 # Exposed to host on 8080 (or 80 if on prod)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - frontend

  backend:
    build:
      context: ./backend
      args:
        PYTHON_VERSION: *python_version
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
      - S3_ENDPOINT=http://minio:9000
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
    depends_on:
      - redis
      - minio

  frontend:
    build: 
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - 5173:5173 # Vite dev server port
    environment:
      # SvelteKit needs to know the public URL for origin checks
      - ORIGIN=http://localhost:8080
      - CHOKIDAR_USEPOLLING=true # For file watching in Docker on some systems
    depends_on:
      - backend

  worker:
    build:
      context: ./worker
      args:
        PYTHON_VERSION: *python_version
    deploy:
      replicas: 3
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data:/data # Shared storage if using local bind mounts
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
      - S3_ENDPOINT=http://minio:9000
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
    depends_on:
      - redis

  redis:
    image: redis:alpine
    volumes:
      - redis_data:/data

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - minio_data:/data

volumes:
  redis_data:
  minio_data:
